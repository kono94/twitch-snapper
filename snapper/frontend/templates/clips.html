{% extends 'base.html' %} {% block content %}
<div class="page-title bg-secondary">
  <h1 class="centered">{% block title %} Clips {% endblock %}</h1>
  <div id="sort-container" class="form-group">
    <label for="sort-select">Sort By:</label>
    <select id="sort-select" class="form-control" style="max-width: 200px">
      <option value="latest" selected>Latest</option>
      <option value="keyword_count">Keyword Count</option>
    </select>
  </div>

  <div id="time-container" class="form-group">
    <label for="time-select">Time:</label>
    <select id="time-select" class="form-control" style="max-width: 200px">
      <option value="1">Today</option>
      <option value="7" selected>Last Week</option>
      <option value="30">Last Month</option>
      <option value="-1">All Time</option>
    </select>
  </div>
</div>

<div class="clips-container" id="main-clips-container"></div>

<script>
  function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
      rect.top >= 0 &&
      rect.left >= 0 &&
      rect.bottom <=
        (window.innerHeight || document.documentElement.clientHeight) &&
      rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
  }

  function replaceIframeWithThumbnail(clipDiv, iframe, clip) {
    // Create a thumbnail image
    const thumbnail = document.createElement("img");
    console.log(clip.thumbnail_url);
    console.log(clip);
    thumbnail.src = clip.thumbnail_url;
    thumbnail.className = "clip-thumbnail";

    // Add click event to thumbnail
    thumbnail.addEventListener("click", () => loadIframe(clip, clipDiv));

    clipDiv.replaceChild(thumbnail, iframe);
  }
</script>
<script>
  let page = 1;
  let loading = false;
  let iframeCheckBlocked = false;
  let allContentLoaded = false; // Flag to indicate if all content has been loaded
  const perPage = 4;
  let clips = [];
  const clipsContainer = document.getElementById("main-clips-container");
  let sortBy = "latest"; // Default sort
  const utcTimestampFromPrevDay = (lastDaysAmount) => {
    return new Date(
      new Date().getTime() - lastDaysAmount * 24 * 60 * 60 * 1000
    ).toISOString();
  };
  let lastUtcTimestamp = utcTimestampFromPrevDay(7);

  // Function to fetch and render clips
  const loadClips = async () => {
    if (loading || allContentLoaded) return; // Prevent additional fetches if already loading
    loading = true;
    console.log(
      `/api/clips?page=${page}&per_page=${perPage}&sort_by=${sortBy}${
        lastUtcTimestamp == null
          ? ""
          : `&last_timestamp_iso=${lastUtcTimestamp}`
      }`
    );
    const response = await fetch(
      `/api/clips?page=${page}&per_page=${perPage}&sort_by=${sortBy}${
        lastUtcTimestamp == null
          ? ""
          : `&last_timestamp_iso=${lastUtcTimestamp}`
      }`
    );

    tmp = await response.json();
    clips = clips.concat(tmp);
    console.log(clips.length);
    console.log("LOADING");
    if (tmp.length < perPage) {
      allContentLoaded = true; // Set flag to true because all content has been loaded
    }

    tmp.forEach((clip) => {
      // Create and append new clip elements
      // This is a simplified example; you'd likely want to use a more complex HTML structure
      const clipDiv = document.createElement("div");
      clipDiv.className = "bg-secondary clip";
      // Add a thumbnail image
      const thumbnail = document.createElement("img");
      thumbnail.src = clip.thumbnail_url;
      thumbnail.className = "clip-thumbnail";

      clipDiv.innerHTML = `
          [${clip.id}] ${clip.twitch_clip_id}<br>
          ${clip.stream.channel_name}<br>
          keyword trigger: ${clip.keyword_trigger}<br>
          keyword amount: ${clip.keyword_count}<br>
          when: ${clip.created}<br>`;

      // Add click event to thumbnail
      thumbnail.addEventListener("click", () => loadIframe(clip, clipDiv));

      clipDiv.appendChild(thumbnail);
      clipsContainer.appendChild(clipDiv);
    });
    loading = false;
  };

  // Function to replace thumbnail with iframe
  const loadIframe = (clip, clipDiv) => {
    const iframe = document.createElement("iframe");
    iframe.src = `https://clips.twitch.tv/embed?clip=${clip.twitch_clip_id}&parent=localhost`;
    iframe.className = "clip-iframe";
    iframe.allowFullscreen = true;
    iframe.style.position = "relative";
    iframe.style.height = "100%";
    iframe.style.width = "100%";
    iframe.frameBorder = "0";

    const thumbnail = clipDiv.querySelector(".clip-thumbnail");

    clipDiv.replaceChild(iframe, thumbnail);
  };

  const initialLoad = async () => {
    while (
      window.innerHeight >= document.body.offsetHeight &&
      !allContentLoaded
    ) {
      await loadClips();
      page++;
    }
  };
  // Initial load
  initialLoad();

  const resetClipsAndContainer = () => {
    page = 1; // Reset to first page
    document.getElementById("main-clips-container").innerHTML = ""; // Clear existing clips
    allContentLoaded = false;
    clips = [];
    loadClips(); // Reload clips
  };

  // Infinite scrolling logic
  window.addEventListener("scroll", () => {
    if (loading || allContentLoaded) return; // If already loading, return

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
      // Reached the bottom, load more clips
      page++;
      loadClips();
      console.log("SCROLL");
    }
  });

  setInterval(() => {
    const clipDivs = document.querySelectorAll(".clip");
    console.log(clipDivs);
    clipDivs.forEach((clipDiv, index) => {
      const iframe = clipDiv.querySelector("iframe");
      if (iframe === null) {
        return;
      }
      if (!isInViewport(iframe)) {
        // Replace iframe with thumbnail
        const clip = clips[index]; // Assuming `clips` is the array containing all your clip data
        console.log(index);
        replaceIframeWithThumbnail(clipDiv, iframe, clip);
      }
    });
    iframeCheckBlocked = false;
  }, 5000);

  document
    .getElementById("sort-select")
    .addEventListener("change", function () {
      sortBy = this.value;
      console.log(sortBy);
      resetClipsAndContainer();
    });

  document
    .getElementById("time-select")
    .addEventListener("change", function () {
      if (this.value == "-1") {
        lastUtcTimestamp = null;
      } else {
        lastUtcTimestamp = utcTimestampFromPrevDay(this.value);
      }
      console.log(lastUtcTimestamp);
      resetClipsAndContainer();
    });
</script>

{% endblock %}
